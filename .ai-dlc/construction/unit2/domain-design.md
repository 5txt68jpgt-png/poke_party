# Domain Design - Unit 2: AI パーティ生成

## 概要

Unit 2 では、ユーザーがテーマを入力し、AIがそのテーマに沿ったポケモンパーティを生成する機能を実装する。

---

## ドメインモデル

### Entity（追加・更新）

#### Party（パーティ）
生成されたパーティを表すエンティティ。

| 属性 | 型 | 説明 |
|------|-----|------|
| id | string | パーティID（UUID） |
| theme | string | 生成テーマ |
| members | PartyPokemon[] | パーティメンバー（1〜6匹） |
| createdAt | Date | 生成日時 |

#### PartyPokemon（パーティ用ポケモン）
パーティに登録されたポケモン。Unit 1 で定義済み。

| 属性 | 型 | 説明 |
|------|-----|------|
| pokemon | Pokemon | ポケモン基本情報 |
| selectedMoves | Move[] | 選定された4つの技 |

---

### Value Object（追加）

#### GenerationRequest（生成リクエスト）
パーティ生成のリクエストを表す値オブジェクト。

| 属性 | 型 | 説明 |
|------|-----|------|
| theme | string | ユーザー入力のテーマ |
| count | number | 生成するポケモン数（1〜6） |

#### AIResponse（AI応答）
AI API からの応答を表す値オブジェクト。

| 属性 | 型 | 説明 |
|------|-----|------|
| pokemonNames | string[] | AIが選定したポケモン名（英語） |
| reasoning | string | 選定理由（オプション） |

---

## ドメインサービス

### PartyGenerationService
パーティ生成を担当するサービス。

| メソッド | 説明 |
|----------|------|
| generateParty(request: GenerationRequest) | テーマからパーティを生成 |

**処理フロー:**
```
1. ユーザー入力（テーマ、匹数）
      ↓
2. AI API 呼び出し
   - テーマを解釈
   - 条件に合うポケモン名を選定
      ↓
3. PokeAPI でバリデーション
   - 各ポケモンが実在するか確認
   - 存在しない場合は再選定 or エラー
      ↓
4. 技選定
   - 各ポケモンの習得可能技を取得
   - バランスを考慮して4つ選定
      ↓
5. パーティ生成完了
```

### MoveSelectionService
技選定を担当するサービス。

| メソッド | 説明 |
|----------|------|
| selectMoves(pokemonId: number, count: number) | 習得可能技から指定数を選定 |

**選定ロジック:**
- タイプ一致技を優先
- 異なるタイプの技をバランス良く
- ダメージ技と変化技のバランス

---

## アーキテクチャ

### AIとPokeAPIの役割分担（RISK-3対応）

```
┌─────────────────────────────────────────────────────┐
│                    ユーザー                          │
│              「第一世代のみで」                        │
└─────────────────────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────┐
│                   AI API                            │
│  ・テーマを解釈                                       │
│  ・条件に合うポケモン「名」を選定                       │
│  ・出力: ["pikachu", "charizard", "gyarados"]       │
└─────────────────────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────┐
│                   PokeAPI                           │
│  ・ポケモン名の実在確認                               │
│  ・ポケモン詳細情報取得                               │
│  ・習得可能技リスト取得                               │
│  ・技詳細情報取得                                    │
└─────────────────────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────┐
│              MoveSelectionService                   │
│  ・習得可能技から4つ選定                              │
│  ・バランス考慮（タイプ、分類）                        │
└─────────────────────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────┐
│                  パーティ完成                         │
│  ・実在するポケモン                                   │
│  ・実際に覚えられる技                                 │
└─────────────────────────────────────────────────────┘
```

**重要**: AIは「ポケモン名の選定」のみを担当し、技は必ずPokeAPIの習得可能技リストから選ぶことで、ハルシネーションを防止する。

---

## API設計

### POST /api/generate-party

**リクエスト:**
```typescript
{
  theme: string;    // テーマ
  count: number;    // 1〜6
}
```

**レスポンス:**
```typescript
{
  party: {
    theme: string;
    members: PartyPokemon[];
  }
}
```

**エラーレスポンス:**
```typescript
{
  error: {
    code: string;
    message: string;
  }
}
```

---

## 状態管理

### 画面の状態

```typescript
type GenerationState =
  | { status: 'idle' }                           // 初期状態
  | { status: 'loading' }                        // 生成中
  | { status: 'success'; party: Party }          // 生成完了
  | { status: 'error'; message: string };        // エラー
```

---

## Unit 2 で実装するもの

1. **型定義**: Party, GenerationRequest, GenerationState
2. **API Route**: /api/generate-party
3. **AI統合**: プロンプト設計、API呼び出し
4. **技選定ロジック**: バランスを考慮した選定
5. **UI**: テーマ入力、匹数選択、パーティ表示、再生成ボタン
